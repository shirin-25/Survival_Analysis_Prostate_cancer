---
title: "Survival Analysis Prostate Cancer"
author: "Shirin ABOUSALIH"
date: "2024-08-25"
output: pdf_document
---

# Install required packages

```{r}

install.packages("asaur")
install.packages("survival")
install.packages("ggplot2")
install.packages("ggfortify")
```

# Load necessary libraries

```{r}
library(asaur)
library(survival)
library(ggplot2)
library(ggfortify)
library(dplyr)

```

# Load the dataset

```{r}
data("prostateSurvival")
prostateSurvival
```

# Drop rows where status is 2
```{r}
prostateSurvival <- prostateSurvival[prostateSurvival$status != 2, ]
```


# Summary of the dataset

```{r}
summary(prostateSurvival)
```

# Frequency table and percentage calculation for 'status'

```{r}
table_status <- table(prostateSurvival$status)
percentages <- prop.table(table_status) * 100
table_status
percentages
```

# Plot: Histogram for 'survTime'

```{r}
hist(prostateSurvival$survTime, 
     main="Histogramme du temps de survie",
     xlab="Temps de survie (jours)", 
     ylab="Fréquence", 
     col="lightblue", 
     border="black")
```

# Plot: Histogram with density curve for 'survTime'

```{r}
hist(prostateSurvival$survTime, 
     main="Histogramme du temps de survie avec courbe de densité",
     xlab="Temps de survie (jours)", 
     ylab="Fréquence", 
     col="lightblue", 
     border="black", 
     prob=TRUE)
lines(density(prostateSurvival$survTime), col="red", lwd=2)
```

# Frequency table and pie chart for 'grade'
```{r}
table_grade <- table(prostateSurvival$grade)
pie(table_grade, 
    main="Répartition des grades", 
    col=rainbow(length(table_grade)),
    labels=paste(names(table_grade), "\n", round(prop.table(table_grade) * 100, 1), "%"))
```



# Frequency table and pie chart for 'stage'
```{r}
table_stage <- table(prostateSurvival$stage)
pie(table_stage, 
    main="Répartition des stades", 
    col=rainbow(length(table_stage)),
    labels=paste(names(table_stage), "\n", round(prop.table(table_stage) * 100, 1), "%"))

```


# Kaplan-Meier survival estimate
```{r}
fit.KM <- survfit(Surv(survTime, status) ~ 1, data = prostateSurvival)
summary(fit.KM)
plot(fit.KM, mark.time = TRUE,
     main = "Kaplan-Meier estimator",
     ylab = "Survival probability",
     xlab = "time (days)")
```



# Nelson-Aalen estimator for cumulative hazard
```{r}
fit.NA <- survfit(Surv(survTime, status) ~ 1, data = prostateSurvival, type = "fh")
summary(fit.NA)
plot(fit.NA, fun = "cumhaz", main = "Nelson-Aalen Cumulative Hazard Curve", xlab = "Time (days)", ylab = "Cumulative Hazard")
```


# Survival curves by 'stage'
```{r}
surv_fit_stage <- survfit(Surv(time = prostateSurvival$survTime, event = prostateSurvival$status) ~ stage, data = prostateSurvival)
plot(surv_fit_stage, col = 1:length(unique(prostateSurvival$stage)), 
     main = "Survival Curves by Stage", xlab = "Time", ylab = "Survival Probability")
legend("bottomleft", legend = levels(prostateSurvival$stage), col = 1:length(unique(prostateSurvival$stage)), lty = 1)

```

# Log-Rank Test for Statistical Comparison by 'grade' and 'stage'
```{r}
log_rank_test_grade <- survdiff(Surv(survTime, status) ~ grade, data = prostateSurvival)
log_rank_test_stage <- survdiff(Surv(survTime, status) ~ stage, data = prostateSurvival)
print(log_rank_test_grade)
print(log_rank_test_stage)
```


# Stratified survival curves by 'grade' and 'stage'

```{r}
stratified_fit <- survfit(Surv(time = prostateSurvival$survTime, event = prostateSurvival$status) ~ grade + stage, data = prostateSurvival)
plot(stratified_fit, col = 1:4, main = "Stratified Survival Curves by Grade and Stage", xlab = "Time (days)", ylab = "Survival Probability")
legend("bottomleft", legend = paste(levels(prostateSurvival$grade), levels(prostateSurvival$stage)), col = 1:4, lty = 1)
```

# Semi-parametric Cox regression analysis
)
```{r}
cox <- coxph(Surv(survTime , status) ~ grade + stage + ageGroup , data = prostateSurvival )
summary(cox)
cox_fit <- survfit(cox)
autoplot(cox_fit)
```

# Verification of the proportional hazard assumption
```{r}
prop <- cox.zph(cox, transform = 'km', global = TRUE)
print(prop)
plot(prop)
```

# Stratified Cox model
```{r}
cox2 <- coxph(Surv(survTime , status) ~ strata(grade) + stage + strata(ageGroup) , data = prostateSurvival)
prop2 <- cox.zph(cox2, transform = 'km', global = TRUE)
print(prop2)
plot(prop2)
```


# Plot stratified Cox model survival curves
```{r}
cox_fit2 <- survfit(cox2)
autoplot(cox_fit2)
```

