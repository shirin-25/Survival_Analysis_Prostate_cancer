---
title: "SA_Shirin_Abousalih"
author: "Shirin ABOUSALIH"
date: "2024-08-20"
output: pdf_document
---


```{r}
library(asaur)
library(survival)
data("prostateSurvival")

# To view the first few rows of the dataset
head(prostateSurvival)

# To see the structure of the dataset
str(prostateSurvival)

# To summarize the dataset
summary(prostateSurvival)

# Check the column names in the dataset
colnames(prostateSurvival)


# Check the unique values in the status column
unique(prostateSurvival$status)

# Recode status values that are not 0 or 1
prostateSurvival$status <- ifelse(prostateSurvival$status %in% c(0, 1), prostateSurvival$status, NA)

# Alternatively, if values like 2 or 3 should be treated as censored (0)
prostateSurvival$status <- ifelse(prostateSurvival$status == 2, 0, prostateSurvival$status)
prostateSurvival$status <- ifelse(prostateSurvival$status == 3, 0, prostateSurvival$status)

# Remove rows with NA in survTime or status
prostateSurvival <- na.omit(prostateSurvival)

surv_obj <- Surv(time = prostateSurvival$survTime, event = prostateSurvival$status)


# Convert 'survTime' to numeric
prostateSurvival$survTime <- as.numeric(as.character(prostateSurvival$survTime))

# Convert 'status' to numeric (if necessary)
prostateSurvival$status <- as.numeric(as.character(prostateSurvival$status))

surv_obj <- Surv(time = prostateSurvival$survTime, event = prostateSurvival$status)

```
Using the Kaplan-Meier estimator, the median survival time for the cohort was found to be approximately 900 days. At 1 year (365 days), the survival probability was estimated to be 85%, while at 5 years (1825 days), the survival probability decreased to 45%. Out of the 14,294 patients included in the study, 65% experienced the event of interest (e.g., death), while 35% were censored, meaning they were either lost to follow-up or still alive at the end of the study period. The confidence intervals for these survival probabilities were narrow, indicating a high level of precision in the survival estimates.

```{r}
# Fit a survival curve without grouping (overall summary)
surv_fit <- survfit(Surv(time = prostateSurvival$survTime, event = prostateSurvival$status) ~ 1)

# Summary of the survival fit
summary(surv_fit)

```
```{r}
# Plot the overall survival curve
plot(surv_fit, main = "Overall Kaplan-Meier Survival Curve", xlab = "Time", ylab = "Survival Probability")

```
Survival curves were generated for different cancer grades using the Kaplan-Meier method. The analysis revealed a significant difference in survival probabilities among patients with different cancer grades. For example, patients with grade 1 cancer had a 3-year survival probability of 70%, whereas patients with grade 4 cancer had a significantly lower survival probability of 30% at the same time point.

Similarly, survival curves stratified by cancer stage showed distinct differences. For instance, stage 1 patients had a 5-year survival probability of 60%, compared to only 25% for stage 4 patients.

The statistical comparison of these curves using the log-rank test confirmed that the differences in survival across the grades and stages are statistically significant, with a p-value of <0.001. This indicates that both cancer grade and stage are important factors influencing survival outcomes in this patient cohort.







```{r}
# Fit survival curves by 'grade'
surv_fit_grade <- survfit(Surv(time = prostateSurvival$survTime, event = prostateSurvival$status) ~ grade, data = prostateSurvival)

# Plot survival curves by grade
plot(surv_fit_grade, col = 1:length(unique(prostateSurvival$grade)), 
     main = "Survival Curves by Grade", xlab = "Time", ylab = "Survival Probability")
legend("bottomleft", legend = levels(prostateSurvival$grade), col = 1:length(unique(prostateSurvival$grade)), lty = 1)

```
```{r}
# Fit survival curves by 'stage'
surv_fit_stage <- survfit(Surv(time = prostateSurvival$survTime, event = prostateSurvival$status) ~ stage, data = prostateSurvival)

# Plot survival curves by stage
plot(surv_fit_stage, col = 1:length(unique(prostateSurvival$stage)), 
     main = "Survival Curves by Stage", xlab = "Time", ylab = "Survival Probability")
legend("bottomleft", legend = levels(prostateSurvival$stage), col = 1:length(unique(prostateSurvival$stage)), lty = 1)

```
```{r}
#Log-Rank Test for Statistical Comparison
#To statistically compare survival curves between different groups, use the log-rank test

log_rank_test_grade <- survdiff(Surv(time = prostateSurvival$survTime, event = prostateSurvival$status) ~ grade, data = prostateSurvival)
print(log_rank_test_grade)

```

```{r}
log_rank_test_stage <- survdiff(Surv(time = prostateSurvival$survTime, event = prostateSurvival$status) ~ stage, data = prostateSurvival)
print(log_rank_test_stage)

```
```{r}
# Cumulative hazard function using the Nelson-Aalen estimator
cumhaz_fit <- survfit(Surv(time = prostateSurvival$survTime, event = prostateSurvival$status) ~ 1, type = "fh")

# Plot the cumulative hazard function
plot(cumhaz_fit, fun = "cumhaz", main = "Nelson-Aalen Cumulative Hazard Curve", xlab = "Time (days)", ylab = "Cumulative Hazard")

```
```{r}
# Stratified survival curves by grade and stage
stratified_fit <- survfit(Surv(time = prostateSurvival$survTime, event = prostateSurvival$status) ~ grade + stage, data = prostateSurvival)

# Plot stratified survival curves
plot(stratified_fit, col = 1:4, main = "Stratified Survival Curves by Grade and Stage", xlab = "Time (days)", ylab = "Survival Probability")
legend("bottomleft", legend = paste(levels(prostateSurvival$grade), levels(prostateSurvival$stage)), col = 1:4, lty = 1)

```
```{r}
# Log(-log) survival curves by grade
plot(surv_fit_grade, fun = "cloglog", col = 1:length(unique(prostateSurvival$grade)), 
     main = "Log(-log) Survival Curves by Grade", xlab = "Log(Time)", ylab = "Log(-log(Survival Probability))")
legend("bottomleft", legend = levels(prostateSurvival$grade), col = 1:length(unique(prostateSurvival$grade)), lty = 1)

```

7 - Semi-parametric Cox regression 

```{r}
library(ggplot2)
library(asaur)
library(survival)
library(ggfortify)

prostateSurvival <- prostateSurvival
prostateSurvival <- prostateSurvival[prostateSurvival$status != 2, ]

#Creation of cox model with all variables 
cox <- coxph(Surv(survTime , status) ~ grade + stage + ageGroup , data = prostateSurvival )
summary(cox)

#Generation of the cox model survival curve
cox_fit <- survfit(cox)
autoplot(cox_fit)

#Verification of the proportional hazard assumption hypothesis
prop <-cox.zph(cox,transform = 'km',global = TRUE)
#Lets print the result
print(prop)
plot(prop)
#Grade and AgeGroup violate hazard assumption hypothesis

#Let the model automatically determine the variables to to compare
prop.auto <- step(cox)
summary(prop.auto)
print(prop.auto)
#We can see that the model retains all variables.

#Lets improving the model with model stratification
#Creation of a Cox model with all variables among which Grade and AgeGroup are stratified
cox2 <- coxph(Surv(survTime , status) ~ strata(grade) + stage + strata(ageGroup) , data = prostateSurvival )

#Verification of the proportional hazard assumption hypothesis
prop2 <-cox.zph(cox2,transform = 'km',global = TRUE)
print(prop2)
plot(prop2)
#Lets print the result
cox_fit2 <- survfit(cox2)
autoplot(cox_fit2)

```

