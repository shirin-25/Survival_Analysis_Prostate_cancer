---
title: "R Notebook"
output: html_notebook
---

#6 - Semi-parametric Cox regression 

```{r}
library(ggplot2)
library(asaur)
library(survival)
library(ggfortify)

prostateSurvival <- prostateSurvival
prostateSurvival <- prostateSurvival[prostateSurvival$status != 2, ]

#Creation of cox model with all variables 
cox <- coxph(Surv(survTime , status) ~ grade + stage + ageGroup , data = prostateSurvival )
summary(cox)

#Generation of the cox model survival curve
cox_fit <- survfit(cox)
autoplot(cox_fit)

#Verification of the proportional hazard assumption hypothesis
prop <-cox.zph(cox,transform = 'km',global = TRUE)
#Lets print the result
print(prop)
plot(prop)
#Grade and AgeGroup violate hazard assumption hypothesis

#Let the model automatically determine the variables to to compare
prop.auto <- step(cox)
summary(prop.auto)
print(prop.auto)
#We can see that the model retains all variables.

#Lets improving the model with model stratification
#Creation of a Cox model with all variables among which Grade and AgeGroup are stratified

cox2 <- coxph(Surv(survTime , status) ~ strata(grade) + stage + strata(ageGroup) , data = prostateSurvival )
prop2 <-cox.zph(cox2,transform = 'km',global = TRUE)
print(prop2)
plot(prop2)
#Lets print the result

cox_fit2 <- survfit(cox2)
autoplot(cox_fit2)

```
